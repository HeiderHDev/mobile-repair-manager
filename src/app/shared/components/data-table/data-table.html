<p-card>
  @if (config().title) {
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center p-4">
        <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">
          {{ config().title }}
        </h2>
        @if (config().showAddButton && config().onAdd) {
          <p-button
            [label]="config().addButtonLabel || 'Agregar'"
            icon="pi pi-plus"
            (onClick)="handleAdd()"
          ></p-button>
        }
      </div>
    </ng-template>
  }

  <ng-template pTemplate="content">
    @if (config().showSearch) {
      <div class="mb-4">
        <div class="p-input-icon-left w-full md:w-auto">
          <i class="pi pi-search"></i>
          <input
            pInputText
            type="text"
            [placeholder]="config().searchPlaceholder || 'Buscar...'"
            [formControl]="searchControl"
            class="w-full md:w-auto"
          />
        </div>
        @if (isServerSidePagination() && getSearchValue()) {
          <small class="text-gray-600 mt-1 block">
            Buscando: "{{ getSearchValue() }}"
          </small>
        }
      </div>
    }

    @if (isServerSidePagination() && paginationInfo()) {
      <div class="pagination-info mb-3 flex justify-between items-center">
        <span>{{ getPaginationText() }}</span>
        <div class="flex items-center gap-2 text-sm">
          @if (paginationInfo()?.page) {
            <span>Página {{ paginationInfo()!.page }}</span>
          }
        </div>
      </div>
    }

    <p-table
      [value]="filteredData()"
      [paginator]="config().paginator ?? true"
      [lazy]="isServerSidePagination()"
      [rows]="pageSize()"
      [totalRecords]="paginationInfo()?.total || filteredData().length"
      [rowsPerPageOptions]="config().rowsPerPageOptions ?? [5, 10, 20, 50]"
      [showCurrentPageReport]="!isServerSidePagination()"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      [loading]="loading()"
      styleClass="p-datatable-striped"
      responsiveLayout="scroll"
      (onPage)="onPageChange($event)"
      [globalFilterFields]="globalFilterFields()"
    >
      <ng-template pTemplate="header">
        <tr>
          @for (column of config().columns; track column.field) {
            <th
              [pSortableColumn]="column.sortable ? getSortableField(column.field) : undefined"
              [style.width]="column.width"
            >
              <div class="flex align-items-center">
                {{ column.header }}
                @if (column.sortable) {
                  <p-sortIcon [field]="getSortableField(column.field)"></p-sortIcon>
                }
              </div>
            </th>
          }
          @if (hasActions()) {
            <th style="width: 200px" class="text-center">Acciones</th>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
        <tr>
          @for (column of config().columns; track column.field) {
            <td>
              @switch (column.type) {
                @case ('date') {
                  {{ formatDate(item[column.field]) }}
                }
                @case ('boolean') {
                  <p-tag
                    [value]="item[column.field] ? 'Activo' : 'Inactivo'"
                    [severity]="item[column.field] ? 'success' : 'danger'"
                  ></p-tag>
                }
                @case ('template') {
                  @if (column.template) {
                    <ng-container
                      *ngTemplateOutlet="column.template; context: { $implicit: item, rowIndex: rowIndex }"
                    ></ng-container>
                  }
                }
                @default {
                  {{ item[column.field] || '-' }}
                }
              }
            </td>
          }
          @if (hasActions()) {
            <td class="text-center">
              <div class="flex gap-1 justify-center flex-wrap">
                @for (action of getVisibleActions(item); track action.label) {
                  <p-button
                    [icon]="action.icon"
                    [severity]="action.severity || 'secondary'"
                    size="small"
                    [disabled]="isActionDisabled(action, item)"
                    [pTooltip]="action.label"
                    tooltipPosition="top"
                    (onClick)="executeAction(action, item)"
                  ></p-button>
                }
              </div>
            </td>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="getTotalColumns()">
            <div class="text-center py-8">
              <i class="pi pi-info-circle text-4xl text-surface-400 mb-4"></i>
              <p class="text-surface-600 dark:text-surface-300 text-lg">
                @if (getSearchValue() && isServerSidePagination()) {
                  No se encontraron resultados para "{{ getSearchValue() }}"
                } @else {
                  {{ config().emptyMessage || 'No hay datos para mostrar' }}
                }
              </p>
              @if (getSearchValue()) {
                <p class="text-surface-500 text-sm mt-2">
                  Intenta con otros términos de búsqueda
                </p>
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr>
          <td [attr.colspan]="getTotalColumns()">
            <div class="text-center py-8">
              <i class="pi pi-spin pi-spinner text-2xl text-surface-400 mb-4"></i>
              <p class="text-surface-600 dark:text-surface-300">
                @if (getSearchValue()) {
                  Buscando "{{ getSearchValue() }}"...
                } @else {
                  Cargando datos...
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    @if (isServerSidePagination() && paginationInfo()) {
      <div class="pagination-info mt-3 flex justify-between items-center text-sm">
        <div class="flex items-center gap-4">
          <span>{{ getPaginationText() }}</span>
          @if (paginationInfo()!.limit) {
            <span class="text-gray-500">
              {{ paginationInfo()!.limit }} por página
            </span>
          }
        </div>
        <div class="flex items-center gap-2">
          @if (hasPrevPage()) {
            <i class="pi pi-angle-left text-blue-600"></i>
            <span class="text-blue-600 text-xs">Anterior disponible</span>
          }
          @if (hasNextPage()) {
            <span class="text-blue-600 text-xs">Siguiente disponible</span>
            <i class="pi pi-angle-right text-blue-600"></i>
          }
        </div>
      </div>
    }
  </ng-template>
</p-card>

<p-confirmDialog></p-confirmDialog>