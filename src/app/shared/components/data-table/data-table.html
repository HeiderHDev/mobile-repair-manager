<p-card>
  @if (config().title) {
    <ng-template pTemplate="header">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-6 bg-gradient-to-r from-surface-50 to-surface-100 dark:from-surface-800 dark:to-surface-900">
        <div>
          <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">
            {{ config().title }}
          </h2>
          @if (paginationInfo()) {
            <p class="text-sm text-surface-600 dark:text-surface-400 mt-1">
              {{ getPaginationText() }}
            </p>
          }
        </div>
        @if (config().showAddButton && config().onAdd) {
          <p-button
            [label]="config().addButtonLabel || 'Agregar'"
            icon="pi pi-plus"
            class="bg-primary-500 hover:bg-primary-600 border-primary-500 hover:border-primary-600"
            (onClick)="handleAdd()"
          ></p-button>
        }
      </div>
    </ng-template>
  }

  <ng-template pTemplate="content">
    @if (config().showSearch) {
      <div class="mb-6">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
          <div class="search-container">
            <i class="pi pi-search search-icon"></i>
            <input
              pInputText
              type="text"
              [placeholder]="config().searchPlaceholder || 'Buscar...'"
              [formControl]="searchControl"
              class="search-input"
            />
          </div>
          @if (isServerSidePagination() && getSearchValue()) {
            <div class="flex items-center gap-2 text-sm bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg">
              <i class="pi pi-search text-blue-600"></i>
              <span class="text-blue-700 dark:text-blue-300">
                Buscando: "<strong>{{ getSearchValue() }}</strong>"
              </span>
            </div>
          }
        </div>
      </div>
    }

    <div class="table-responsive">
      <p-table
        [value]="filteredData()"
        [paginator]="config().paginator ?? true"
        [lazy]="isServerSidePagination()"
        [rows]="pageSize()"
        [totalRecords]="paginationInfo()?.total || filteredData().length"
        [rowsPerPageOptions]="config().rowsPerPageOptions ?? [5, 10, 20, 50]"
        [showCurrentPageReport]="!isServerSidePagination()"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
        [loading]="loading()"
        styleClass="p-datatable-striped"
        responsiveLayout="scroll"
        (onPage)="onPageChange($event)"
        [globalFilterFields]="globalFilterFields()"
      >
        <ng-template pTemplate="header">
          <tr>
            @for (column of config().columns; track column.field) {
              <th
                [pSortableColumn]="column.sortable ? getSortableField(column.field) : undefined"
                [style.width]="column.width"
                class="bg-surface-100 dark:bg-surface-800"
              >
                <div class="flex align-items-center font-semibold">
                  {{ column.header }}
                  @if (column.sortable) {
                    <p-sortIcon [field]="getSortableField(column.field)"></p-sortIcon>
                  }
                </div>
              </th>
            }
            @if (hasActions()) {
              <th class="actions-column text-center bg-surface-100 dark:bg-surface-800">
                <span class="font-semibold">Acciones</span>
              </th>
            }
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
          <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
            @for (column of config().columns; track column.field) {
              <td>
                @switch (column.type) {
                  @case ('date') {
                    <span class="text-surface-700 dark:text-surface-300">
                      {{ formatDate(item[column.field]) }}
                    </span>
                  }
                  @case ('boolean') {
                    <p-tag
                      [value]="item[column.field] ? 'Activo' : 'Inactivo'"
                      [severity]="item[column.field] ? 'success' : 'danger'"
                      class="font-medium"
                    ></p-tag>
                  }
                  @case ('template') {
                    @if (column.template) {
                      <ng-container
                        *ngTemplateOutlet="column.template; context: { $implicit: item, rowIndex: rowIndex }"
                      ></ng-container>
                    }
                  }
                  @default {
                    <span class="text-surface-700 dark:text-surface-300">
                      {{ item[column.field] || '-' }}
                    </span>
                  }
                }
              </td>
            }
            @if (hasActions()) {
              <td class="text-center">
                <div class="actions-container">
                  @for (action of getPrimaryActions(item); track action.label) {
                    <p-button
                      [icon]="action.icon"
                      [severity]="action.severity || 'secondary'"
                      size="small"
                      [disabled]="isActionDisabled(action, item)"
                      [pTooltip]="action.label"
                      tooltipPosition="top"
                      class="action-button"
                      (onClick)="executeAction(action, item)"
                    ></p-button>
                  }
                  
                  @if (hasOverflowActions(item)) {
                    <div class="actions-overflow">
                      <p-button
                        icon="pi pi-ellipsis-h"
                        size="small"
                        [text]="true"
                        class="more-actions-btn"
                        pTooltip="Más acciones"
                        tooltipPosition="top"
                        (onClick)="op.toggle($event)"
                      ></p-button>
                      
                      <p-popover #op>
                        <div class="flex flex-col gap-1 min-w-[150px]">
                          @for (action of getOverflowActions(item); track action.label) {
                            <p-button
                              [label]="action.label"
                              [icon]="action.icon"
                              [severity]="action.severity || 'secondary'"
                              size="small"
                              [text]="true"
                              [disabled]="isActionDisabled(action, item)"
                              class="justify-start"
                              (onClick)="executeAction(action, item); op.hide()"
                            ></p-button>
                          }
                        </div>
                      </p-popover>
                    </div>
                  }
                </div>
              </td>
            }
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getTotalColumns()">
              <div class="text-center py-12">
                <div class="flex flex-col items-center gap-4">
                  <div class="w-16 h-16 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center">
                    <i class="pi pi-info-circle text-2xl text-surface-400"></i>
                  </div>
                  <div>
                    <p class="text-surface-600 dark:text-surface-300 text-lg font-medium">
                      @if (getSearchValue() && isServerSidePagination()) {
                        No se encontraron resultados
                      } @else {
                        {{ config().emptyMessage || 'No hay datos para mostrar' }}
                      }
                    </p>
                    @if (getSearchValue()) {
                      <p class="text-surface-500 text-sm mt-2">
                        No hay resultados para "<strong>{{ getSearchValue() }}</strong>"
                      </p>
                      <p class="text-surface-400 text-xs mt-1">
                        Intenta con otros términos de búsqueda
                      </p>
                    }
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
          <tr>
            <td [attr.colspan]="getTotalColumns()">
              <div class="text-center py-12">
                <div class="flex flex-col items-center gap-4">
                  <div class="w-8 h-8 animate-spin">
                    <i class="pi pi-spinner text-2xl text-primary-500"></i>
                  </div>
                  <p class="text-surface-600 dark:text-surface-300 font-medium">
                    @if (getSearchValue()) {
                      Buscando "{{ getSearchValue() }}"...
                    } @else {
                      Cargando datos...
                    }
                  </p>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    @if (isServerSidePagination() && paginationInfo()) {
      <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4 p-4 bg-surface-50 dark:bg-surface-800 rounded-lg">
        <div class="flex flex-col sm:flex-row items-center gap-4 text-sm">
          <span class="pagination-info">{{ getPaginationText() }}</span>
          @if (paginationInfo()!.limit) {
            <span class="text-surface-500 dark:text-surface-400">
              {{ paginationInfo()!.limit }} por página
            </span>
          }
        </div>
        <div class="flex items-center gap-4 text-sm">
          @if (hasPrevPage()) {
            <div class="flex items-center gap-1 text-primary-600">
              <i class="pi pi-angle-left"></i>
              <span>Anterior disponible</span>
            </div>
          }
          @if (hasNextPage()) {
            <div class="flex items-center gap-1 text-primary-600">
              <span>Siguiente disponible</span>
              <i class="pi pi-angle-right"></i>
            </div>
          }
        </div>
      </div>
    }
  </ng-template>
</p-card>

<p-confirmDialog></p-confirmDialog>